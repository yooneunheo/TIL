## 11. RAF의 비밀

<br>

![23](https://user-images.githubusercontent.com/75867748/109422871-9f97cd00-7a20-11eb-8f58-dc8dba63ecd0.png)

이 예제를 보면, 버튼에 클릭이 발생하게 되면 여기 콜백 함수가 수행이 되는데 이 콜백 함수에서는 웹 API 중 하나인 RAF라는 API를 호출하게 된다. 이 API에는 우리가 등록한 <B>콜백함수가 나중에 브라우저에서 다음 렌더링이 발생하기 전에 이 콜백이 수행되는 것을 보장</B>한다.

웹 API에서 버튼 리스너가 등록이 되었고 버튼에 이벤트가 발생하면 웹 API가 태스크 큐에 우리의 콜백 함수를 여기에다 등록을 한다. 그리고 이벤트 루프가 빙글빙글 돌다가 태스크 큐에 있는 아이템을 콜 스택으로 가져오게 된다. 콜 스택에서 드디어 이벤트 리스너의 콜백 함수가 수행이 된다. 이 콜백 안에는 총 세 가지 일이 일어나는데 이렇게 각각 세 개의 API를 호출하게 된다. 그리고 RAF 내의 큐 안에 각각 색상을 변경하는 콜백이 순서대로 등록되어져 있다. 이렇게 RAF 콜백을 등록해놓고 클릭 리스너의 콜백이 다 끝난다면 이제 이벤트 루프가 다시 빙글빙글 돌다가 브라우저가 업데이트 할 때가 되었을 때 렌더 시퀀스에 진입한다. 그리고 RAF 큐에 있는 아이템을 순서대로 처리한 후 최종적으로 마지막 코드가 적용이 된 상태에서 렌더 트리 -> 레이아웃 -> 페인트를 거치게 된다.

<b>지금 클릭이 발생한 지점에는 코드를 변경하지 않아도 되는데 나중에 브라우저가 업데이트 되기 전에 이 코드를 수행해줘라고 할 때 이 RAF를 쓴다</b>

---

##### 0밀리세컨드에 실행되는 setTimeOut

콜 스택 안에서 이 코드 블럭이 실행되는 이 순간 말고 이게 끝나고 이벤트 루프가 한 바퀴 돌 때 그 다음에 이 코드 블럭을 실행해달라고 말하고 싶을 때쓴다. 즉, 내가 무언가를 변경하고 나서 다음 차례 때 다음 이벤트 루프가 동작할 때 내 것을 실행해 달라고 이 때 많이 쓴다.

![24](https://user-images.githubusercontent.com/75867748/109422956-fdc4b000-7a20-11eb-8675-ee82e6c303ff.jpg)

이 예시에서 보면, 클릭이 발생할 때 클릭에 등록된 콜백 함수가 콜 스택에서 수행되다가 지금 말고 조금만 있다가 다음 턴때 이벤트 루프가 다음에 한 바퀴 돌 때 그 때 실행하고 싶을 때 setTimeOut(0)을 이용하게 되면, 웹 APIs한테 "0밀리 새컨드 있다가 이 콜백을 태스크 큐에 넣어줘" 라고 해서 웹 APIs는 0밀리세컨드 있다가 여기 태스크 큐에 아이템을 등록하게 된다. 그리고 이 콜 스택이 다 끝난 다음에 콜 스택이 텅텅 비어지게 되면 setTimeOut 콜백을 다시 가지고 와서 수행한다. 즉 모든 코드가 수행이 된 다음 그 다음 턴 때 여기 setTimeOut에 있는 코드 블럭이 수행된다.

![25](https://user-images.githubusercontent.com/75867748/109422958-fef5dd00-7a20-11eb-8aa2-cde0681119c9.png)

---

#### 총정리

자바 스크립트 엔진에는 힙과 콜 스택이 있다.
콜 스택은 함수가 실행되는 과정을 기억하기 위해 쓰이는 자료구조이다. 그리고 자바 스크립트가 동작하는 런타임 환경에서는 이렇게 태스크 큐와 마이크로 태스크 큐를 이용해서 비동저기적인 처리를 하게 되는데 태스크 큐는 한 번에 하나씩만 가지고 오고 마이크로 태스크 큐는 들어 있는 아이들 모두 다 수행할 때까지 가지고 오게 된다. 랜더는 이벤트 루프가 매번은 아니지만 주기적으로 브라우저에게 UI를 업데이트 하기 위해서 자주 들러준다. 그리고 우리가 호출한 RAF의 큐는 업데이트가 일어나기 전에 한번 쭉 순회하면서 코드가 실행된다.
